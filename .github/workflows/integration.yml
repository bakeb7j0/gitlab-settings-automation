name: Integration Tests

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      prime_environment:
        description: 'Prime test environment before running'
        required: false
        default: 'false'
        type: boolean

  # Run after merges to main
  push:
    branches: [main]
    paths:
      - 'gl_settings.py'
      - 'tests/integration/**'

  # Nightly at 2am UTC
  schedule:
    - cron: '0 2 * * *'

env:
  GL_TEST_GROUP: testtarget

jobs:
  integration:
    runs-on: ubuntu-latest
    # Only run if we have access to secrets (not on fork PRs)
    if: github.repository == 'bakeb7j0/gitlab-settings-automation'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install gl-settings
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install glab CLI
        run: |
          curl -fsSL https://gitlab.com/gitlab-org/cli/-/releases/v1.36.0/downloads/glab_1.36.0_Linux_x86_64.tar.gz | tar xz
          sudo mv bin/glab /usr/local/bin/

      - name: Configure glab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          glab auth login --hostname gitlab.com --token "$GITLAB_TOKEN"

      - name: Prime test environment
        if: inputs.prime_environment == 'true'
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          cd tests/integration
          echo "y" | ./prime.sh

      - name: Run integration tests
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          cd tests/integration
          ./run-all.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: tests/integration/*.log
          retention-days: 7
          if-no-files-found: ignore
